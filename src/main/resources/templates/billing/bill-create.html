<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Create Bill</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }

        .main-card {
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: none;
        }

        .header-title { font-weight: 700; color: #b91c1c; }

        .btn-add { background-color: #16a34a; color: white; }
        .btn-add:hover { background-color: #15803d; }

        .btn-danger-custom { background-color: #dc2626; color: white; }

        .qty-btn { width: 28px; height: 28px; padding: 0; }

        .total-box { font-size: 1.6rem; font-weight: bold; }
        .grand-total { color: #16a34a; }

        .search-dropdown {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            position: absolute;
            width: 100%;
            z-index: 1000;
        }

        .search-item { padding: 8px 12px; cursor: pointer; }
        .search-item:hover { background-color: #f3f4f6; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="card main-card p-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="header-title">üç∫ Create New Bill</h3>
            <a th:href="@{/billing/bills}" class="btn btn-outline-secondary btn-sm">My Bills</a>
        </div>

        <hr>

        <form th:action="@{/billing/bills/new}"
              th:object="${billRequest}"
              method="post">

            <div class="row mb-3 position-relative">

                <!-- Brand Search -->
                <div class="col-md-6 col-12 mb-2">
                    <label class="form-label fw-bold">Search Brand</label>
                    <input type="text"
                           id="brandSearch"
                           class="form-control"
                           placeholder="Type brand name...">
                    <div id="searchResults" class="search-dropdown d-none"></div>
                </div>

                <!-- Size Dropdown -->
                <div class="col-md-2 col-6 mb-2">
                    <label class="form-label">Size</label>
                    <select id="sizeSelect" class="form-select">
                        <option value="">Select Size</option>
                    </select>
                </div>

                <!-- Quantity Input -->
                <div class="col-md-2 col-6 mb-2">
                    <label class="form-label">Qty</label>
                    <input type="number" id="quantity" min="1"
                           class="form-control" value="1">
                </div>

                <!-- Add Item Button -->
                <div class="col-md-2 col-12 d-flex align-items-end">
                    <button type="button"
                            class="btn btn-add w-100"
                            onclick="addItem()">
                        Add Item
                    </button>
                </div>
            </div>

            <!-- Bill Table -->
            <div class="table-responsive mt-3">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Brand</th>
                        <th>Size</th>
                        <th>Unit Price</th>
                        <th class="text-center">Qty</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody id="billTableBody"></tbody>
                </table>
            </div>

            <!-- Grand Total -->
            <div class="d-flex justify-content-between total-box mt-3">
                <span>Grand Total</span>
                <span class="grand-total">
                    ‚Çπ <span id="grandTotal">0.00</span>
                </span>
            </div>

            <div id="hiddenItems"></div>

            <button type="submit"
                    id="saveBtn"
                    class="btn btn-success w-100 mt-4"
                    disabled>
                Save Bill
            </button>
        </form>
    </div>
</div>

<script th:inline="javascript">
/*<![CDATA[*/

// Thymeleaf will serialize BrandBillingDTO correctly since it's a clean DTO
const brands = /*[[${brands}]]*/ [];
console.log("Brands loaded:", brands); // ‚Üê check this first in console

let billItems = [];
let selectedBrand = null;

const searchInput = document.getElementById("brandSearch");
const resultsBox = document.getElementById("searchResults");
const sizeSelect = document.getElementById("sizeSelect");
const quantityInput = document.getElementById("quantity");
const saveBtn = document.getElementById("saveBtn");

// LIVE SEARCH
searchInput.addEventListener("input", function () {
    const query = this.value.toLowerCase().trim();
    resultsBox.innerHTML = "";

    if (!query) {
        resultsBox.classList.add("d-none");
        return;
    }

    const filtered = brands.filter(b => b.name && b.name.toLowerCase().includes(query));

    if (filtered.length === 0) {
        resultsBox.innerHTML = `<div class="search-item text-danger">No brand found</div>`;
    } else {
        filtered.forEach(brand => {
            const div = document.createElement("div");
            div.className = "search-item";
            div.textContent = brand.name;
            div.addEventListener("click", () => selectBrand(brand.id));
            resultsBox.appendChild(div);
        });
    }

    resultsBox.classList.remove("d-none");
});

// Hide dropdown when clicking outside
document.addEventListener("click", function (e) {
    if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
        resultsBox.classList.add("d-none");
    }
});

// SELECT BRAND
function selectBrand(id) {
    selectedBrand = brands.find(b => Number(b.id) === Number(id));
    if (!selectedBrand) return;

    console.log("Selected brand:", selectedBrand);
    console.log("Sizes:", selectedBrand.sizes);

    searchInput.value = selectedBrand.name;
    resultsBox.classList.add("d-none");

    sizeSelect.innerHTML = `<option value="">Select Size</option>`;

    if (!selectedBrand.sizes || selectedBrand.sizes.length === 0) {
        sizeSelect.innerHTML += `<option disabled>No sizes available</option>`;
        return;
    }

    selectedBrand.sizes.forEach(size => {
        sizeSelect.innerHTML +=
            `<option value="${size.id}"
                     data-price="${size.price}"
                     data-label="${size.sizeLabel}">
                ${size.sizeLabel} - ‚Çπ${size.price}
             </option>`;
    });
}

// ADD ITEM
function addItem() {
    if (!selectedBrand) { alert("Select a brand first."); return; }

    const selectedOption = sizeSelect.options[sizeSelect.selectedIndex];
    if (!selectedOption || !selectedOption.value) { alert("Select a size."); return; }

    const qty = parseInt(quantityInput.value);
    if (!qty || qty <= 0) { alert("Enter a valid quantity."); return; }

    const price = parseFloat(selectedOption.dataset.price);
    const sizeLabel = selectedOption.dataset.label;
    const brandSizeId = selectedOption.value;

    const existing = billItems.find(i => i.brandSizeId == brandSizeId);
    if (existing) {
        existing.quantity += qty;
        existing.lineTotal = existing.quantity * existing.price;
    } else {
        billItems.push({
            brandSizeId,
            brandName: selectedBrand.name,
            sizeLabel,
            price,
            quantity: qty,
            lineTotal: price * qty
        });
    }

    renderTable();
}

// RENDER TABLE
function renderTable() {
    const tbody = document.getElementById("billTableBody");
    const hiddenDiv = document.getElementById("hiddenItems");
    tbody.innerHTML = "";
    hiddenDiv.innerHTML = "";

    let total = 0;

    billItems.forEach((item, index) => {
        total += item.lineTotal;

        tbody.innerHTML += `
            <tr>
                <td>${item.brandName}</td>
                <td>${item.sizeLabel}</td>
                <td>‚Çπ${item.price.toFixed(2)}</td>
                <td class="text-center">
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <button type="button" class="btn btn-sm btn-outline-danger qty-btn"
                                onclick="decreaseQty(${index})">-</button>
                        <span>${item.quantity}</span>
                        <button type="button" class="btn btn-sm btn-outline-success qty-btn"
                                onclick="increaseQty(${index})">+</button>
                    </div>
                </td>
                <td>‚Çπ${item.lineTotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm"
                            onclick="removeItem(${index})">‚úï</button>
                </td>
            </tr>`;

        hiddenDiv.innerHTML += `
            <input type="hidden" name="items[${index}].brandSizeId" value="${item.brandSizeId}">
            <input type="hidden" name="items[${index}].quantity" value="${item.quantity}">`;
    });

    document.getElementById("grandTotal").innerText = total.toFixed(2);
    saveBtn.disabled = billItems.length === 0;
}

function increaseQty(index) {
    billItems[index].quantity++;
    billItems[index].lineTotal = billItems[index].quantity * billItems[index].price;
    renderTable();
}

function decreaseQty(index) {
    if (billItems[index].quantity > 1) {
        billItems[index].quantity--;
        billItems[index].lineTotal = billItems[index].quantity * billItems[index].price;
        renderTable();
    }
}

function removeItem(index) {
    billItems.splice(index, 1);
    renderTable();
}

/*]]>*/
</script>

</body>
</html>