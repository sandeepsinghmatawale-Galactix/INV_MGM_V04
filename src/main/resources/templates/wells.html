<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Well Inventory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .table-input    { width: 100px; }
        .consumed-cell  { background-color: #f0fff0; font-weight: bold; }
        .received-cell  { background-color: #e9ecef; }
        .prefilled      { background-color: #fff9c4; }
        .no-stock-row   { background-color: #f8f9fa; color: #6c757d; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-success">
    <div class="container-fluid">
        <span class="navbar-brand">
            <i class="bi bi-cup-straw"></i>
            Well Inventory - <span th:text="${bar.barName}"></span>
        </span>
        <span class="text-white">
            Session #<span th:text="${sessionId}"></span>
            | Shift: <span th:text="${inv.shiftType}"></span>
        </span>
    </div>
</nav>

<div class="container-fluid mt-4">

    <div id="errorMsg"   class="alert alert-danger"  style="display:none;"></div>
    <div id="successMsg" class="alert alert-success" style="display:none;"></div>

    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        Brands with <strong>previous closing stock</strong> are shown even if no
        stock was distributed today. Enter their closing stock to track consumption.
    </div>

    <div class="card shadow">
        <div class="card-header bg-success text-white d-flex justify-content-between">
            <h5 class="mb-0">
                <i class="bi bi-3-circle"></i> Stage 3: Well Inventory
            </h5>
            <div>
                <span class="badge bg-warning text-dark me-1">
                    <i class="bi bi-square-fill"></i> Pre-filled from previous session
                </span>
                <span class="badge bg-secondary">
                    <i class="bi bi-lock"></i> Received locked
                </span>
            </div>
        </div>
        <div class="card-body">

            <form id="wellForm"
                  th:action="@{/sessions/wells/{id}/save(id=${sessionId})}"
                  method="post">

                <div class="table-responsive">
                    <table class="table table-bordered align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Product</th>
                                <th>Well</th>
                                <th>Opening Stock
                                    <small class="d-block fw-normal opacity-75">
                                        ← prev. closing
                                    </small>
                                </th>
                                <th>Received
                                    <small class="d-block fw-normal opacity-75">
                                        ← distribution
                                    </small>
                                </th>
                                <th>Closing Stock</th>
                                <th class="consumed-cell">Consumed</th>
                                <th>Selling Price</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            <th:block th:each="product : ${products}">
                                <tr th:each="wellName : ${wellNames}"
                                    th:with="
                                        distKey=${product.productId + '_' + wellName},
                                        received=${distributionMap != null
                                                   ? distributionMap[product.productId + '_' + wellName]
                                                   : null},
                                        prevClose=${previousClosing != null
                                                    and previousClosing[product.productId + '_' + wellName] != null
                                                    ? previousClosing[product.productId + '_' + wellName]
                                                    : 0},
                                        hasReceived=${received != null and received > 0},
                                        hasPrevClose=${prevClose != null and prevClose > 0}">

                                    <!--
                                        ✅ SHOW ROW IF:
                                        - received stock from distribution today  (hasReceived)
                                        - OR had closing stock in previous session (hasPrevClose)
                                        HIDE ROW ONLY IF: brand was never used in this bar at this well
                                    -->
                                    <th:block th:if="${hasReceived or hasPrevClose}">

                                        <td>
                                            <strong th:text="${product.productName}"></strong><br>
                                            <small class="text-muted"
                                                   th:text="${product.brand}"></small>
                                        </td>

                                        <td>
                                            <span class="badge bg-secondary"
                                                  th:text="${wellName}"></span>
                                        </td>

                                        <!-- Opening - pre-filled from previous closing -->
                                        <td>
                                            <input type="number" step="0.01" min="0"
                                                   class="form-control table-input opening"
                                                   th:classappend="${hasPrevClose} ? ' prefilled'"
                                                   th:name="'opening_' + ${product.productId}
                                                             + '_' + ${wellName}"
                                                   th:value="${prevClose}"/>
                                            <small th:if="${hasPrevClose}"
                                                   class="text-success fw-bold">
                                                ↑ prev closing
                                            </small>
                                        </td>

                                        <!-- Received - locked, 0 if not distributed today -->
                                        <td class="received-cell">
                                            <input type="number" step="0.01"
                                                   class="form-control table-input received"
                                                   th:name="'received_' + ${product.productId}
                                                             + '_' + ${wellName}"
                                                   th:value="${received != null ? received : 0}"
                                                   readonly
                                                   style="background-color:#e9ecef;
                                                          font-weight:bold;"/>
                                            <small th:if="${!hasReceived}"
                                                   class="text-muted">no restock today</small>
                                        </td>

                                        <!-- Closing -->
                                        <td>
                                            <input type="number" step="0.01" min="0"
                                                   class="form-control table-input closing"
                                                   th:name="'closing_' + ${product.productId}
                                                             + '_' + ${wellName}"
                                                   value="0"/>
                                        </td>

                                        <!-- Consumed - auto calculated -->
                                        <td class="consumed-cell">
                                            <input type="number" step="0.01"
                                                   class="form-control table-input consumed"
                                                   th:name="'consumed_' + ${product.productId}
                                                             + '_' + ${wellName}"
                                                   value="0" readonly/>
                                        </td>

                                        <!-- Selling Price -->
                                        <td>
                                            <span th:text="${prices[product.productId] != null
                                                             ? prices[product.productId].sellingPrice
                                                             : 'N/A'}">
                                            </span>
                                        </td>

                                        <!-- Note column -->
                                        <td>
                                            <span th:if="${hasReceived and hasPrevClose}"
                                                  class="badge bg-success">
                                                Restocked
                                            </span>
                                            <span th:if="${hasPrevClose and !hasReceived}"
                                                  class="badge bg-warning text-dark">
                                                Carry Forward
                                            </span>
                                            <span th:if="${hasReceived and !hasPrevClose}"
                                                  class="badge bg-info text-dark">
                                                New Stock
                                            </span>
                                        </td>

                                    </th:block>
                                </tr>
                            </th:block>
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a th:href="@{/sessions/distribution/{id}(id=${sessionId})}"
                       class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Distribution
                    </a>
                    <button type="button"
                            onclick="saveAndCommit()"
                            class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle"></i> Save &amp; Commit Session
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const sessionId = [[${sessionId}]];
    const barId     = [[${barId}]];

    // Auto-calculate consumed for every visible row
    document.querySelectorAll("tbody tr").forEach(row => {
        const opening  = row.querySelector(".opening");
        const received = row.querySelector(".received");
        const closing  = row.querySelector(".closing");
        const consumed = row.querySelector(".consumed");

        if (opening && received && closing && consumed) {
            function calculate() {
                const o = parseFloat(opening.value)  || 0;
                const r = parseFloat(received.value) || 0;
                const c = parseFloat(closing.value)  || 0;
                const result = o + r - c;
                consumed.value = result >= 0 ? result.toFixed(2) : "0.00";
            }
            calculate(); // run on load with pre-filled values
            opening.addEventListener("input",  calculate);
            received.addEventListener("input", calculate);
            closing.addEventListener("input",  calculate);
        }
    });

    function saveAndCommit() {
        const form       = document.getElementById("wellForm");
        const formData   = new FormData(form);
        const errorDiv   = document.getElementById("errorMsg");
        const successDiv = document.getElementById("successMsg");

        errorDiv.style.display   = "none";
        successDiv.style.display = "none";

        fetch(`/sessions/wells/${sessionId}/save`, {
            method: "POST",
            body: new URLSearchParams(formData)
        })
        .then(res => {
            if (!res.ok) return res.text().then(t => { throw new Error(t); });
            return res;
        })
        .then(() => fetch(`/api/sessions/${sessionId}/commit`, { method: "POST" }))
        .then(res => {
            if (!res.ok) return res.text().then(t => { throw new Error(t); });
            return res;
        })
        .then(() => {
            successDiv.textContent   = "Session committed! Redirecting...";
            successDiv.style.display = "block";
            setTimeout(() => window.location.href = `/sessions/${barId}`, 1500);
        })
        .catch(err => {
            errorDiv.textContent   = "Error: " + err.message;
            errorDiv.style.display = "block";
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>