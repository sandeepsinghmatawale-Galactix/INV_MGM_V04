<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Distribution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .calculated        { background-color: #fff3cd; font-weight: bold; }
        .status-pending    { background-color: #f8d7da; }
        .status-allocated  { background-color: #d4edda; }
        .remaining-zero    { color: #198754; font-weight: bold; }
        .remaining-nonzero { color: #dc3545; font-weight: bold; }
        .well-input        { width: 90px; text-align: right; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-warning">
    <div class="container-fluid">
        <span class="navbar-brand text-dark">
            <i class="bi bi-diagram-3"></i>
            Distribution - Session #<span th:text="${sessionId}"></span>
        </span>
        <span class="text-dark fw-bold">
            Bar: <span th:text="${bar != null ? bar.barName : 'N/A'}"></span>
            | Shift: <span th:text="${inv.shiftType}"></span>
        </span>
    </div>
</nav>

<div class="container mt-4">

    <!-- Error from server -->
    <div th:if="${error}" class="alert alert-danger">
        <i class="bi bi-x-circle"></i> <span th:text="${error}"></span>
    </div>

    <!-- Client-side validation error -->
    <div id="globalError" class="alert alert-danger" style="display:none;">
        <i class="bi bi-x-circle"></i>
        <span id="globalErrorMsg"></span>
    </div>

    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        Distribute ALL stock from stockroom to wells.
        <strong>Remaining must be 0.00 for every product before you can proceed.</strong>
    </div>

    <div class="card shadow">
        <div class="card-header bg-warning d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-2-circle"></i> Stage 2: Distribute Stock to Wells
            </h5>
            <span class="badge bg-dark"
                  th:text="${'Wells: ' + wellNames.size()}"></span>
        </div>

        <div class="card-body">

            <!-- Empty state -->
            <div th:if="${distributions == null or #lists.isEmpty(distributions)}"
                 class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                No distribution records found. Go back and complete stockroom first.
            </div>

            <!-- Distribution table -->
            <div th:if="${distributions != null and !#lists.isEmpty(distributions)}">

                <form id="distributionForm"
                      th:action="@{/sessions/distribution/{id}/save(id=${sessionId})}"
                      method="post">

                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th class="text-center">From Stockroom</th>
                                    <!-- Dynamic well column headers -->
                                    <th class="text-center"
                                        th:each="wellName : ${wellNames}"
                                        th:text="${wellName}">
                                    </th>
                                    <th class="text-center calculated">Total Allocated</th>
                                    <th class="text-center calculated">Remaining</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr th:each="dist : ${distributions}"
                                    th:data-product="${dist.product.productId}"
                                    th:data-stockroom="${dist.quantityFromStockroom}">

                                    <!-- Product name + brand -->
                                    <td>
                                        <strong th:text="${dist.product != null
                                                           ? dist.product.productName
                                                           : 'N/A'}">
                                        </strong><br>
                                        <small class="text-muted"
                                               th:text="${dist.product != null
                                                          ? dist.product.brand
                                                          : ''}">
                                        </small>
                                        <!-- Hidden product id for JS -->
                                        <input type="hidden"
                                               th:name="'productId_' + ${dist.product.productId}"
                                               th:value="${dist.product.productId}"/>
                                    </td>

                                    <!-- Category -->
                                    <td th:text="${dist.product != null
                                                   ? dist.product.category
                                                   : 'N/A'}">
                                    </td>

                                    <!-- From Stockroom quantity -->
                                    <td class="text-center fw-bold"
                                        th:text="${dist.quantityFromStockroom != null
                                                   ? dist.quantityFromStockroom
                                                   : 0}">
                                    </td>

                                    <!-- One input per well -->
                                    <td th:each="wellName : ${wellNames}"
                                        class="text-center">
                                        <input type="number"
                                               step="0.01"
                                               min="0"
                                               class="form-control well-input well-allocation"
                                               th:name="'alloc_' + ${dist.product.productId}
                                                         + '_' + ${wellName}"
                                               th:data-product="${dist.product.productId}"
                                               th:placeholder="${wellName}"
                                               value="0"/>
                                    </td>

                                    <!-- Total allocated - JS calculated -->
                                    <td class="text-center calculated">
                                        <span class="total-allocated"
                                              th:data-product="${dist.product.productId}">
                                            0.00
                                        </span>
                                    </td>

                                    <!-- Remaining - must reach 0 -->
                                    <td class="text-center">
                                        <span class="remaining remaining-nonzero"
                                              th:data-product="${dist.product.productId}"
                                              th:text="${dist.quantityFromStockroom}">
                                        </span>
                                    </td>

                                    <!-- Status badge -->
                                    <td class="text-center">
                                        <span class="badge bg-danger"
                                              th:id="'status_' + ${dist.product.productId}">
                                            PENDING
                                        </span>
                                    </td>

                                </tr>
                            </tbody>

                            <!-- Footer totals -->
                            <tfoot class="table-dark">
                                <tr>
                                    <td colspan="2" class="text-end fw-bold">TOTAL:</td>
                                    <td class="text-center fw-bold"
                                        id="totalStockroom">0.00</td>
                                    <!-- Per-well totals -->
                                    <td class="text-center fw-bold"
                                        th:each="wellName : ${wellNames}"
                                        th:id="'totalWell_' + ${wellName}">
                                        0.00
                                    </td>
                                    <td class="text-center fw-bold"
                                        id="totalAllocated">0.00</td>
                                    <td class="text-center fw-bold"
                                        id="totalRemaining">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <a th:href="@{/stockroom/{id}(id=${sessionId})}"
                           class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Stockroom
                        </a>
                        <div class="d-flex gap-2">
                            <button type="button"
                                    onclick="autoDistribute()"
                                    class="btn btn-outline-primary">
                                <i class="bi bi-lightning"></i> Auto Distribute Equally
                            </button>
                            <button type="button"
                                    onclick="validateAndSave()"
                                    class="btn btn-primary">
                                Save &amp; Proceed to Wells
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>

<script th:inline="javascript">
    const wellNames = [[${wellNames}]];
    const sessionId = [[${sessionId}]];

    // Build stockroom map: productId → stockroom quantity
    const stockroomMap = {};
    document.querySelectorAll("tbody tr[data-product]").forEach(row => {
        stockroomMap[row.dataset.product] = parseFloat(row.dataset.stockroom) || 0;
    });

    // ── Recalculate one product row ──────────────────────────────────────
    function recalculateRow(productId) {
        const stockroom = stockroomMap[productId] || 0;
        let totalAllocated = 0;

        document.querySelectorAll(`.well-allocation[data-product="${productId}"]`)
            .forEach(input => {
                totalAllocated += parseFloat(input.value) || 0;
            });

        const remaining = parseFloat((stockroom - totalAllocated).toFixed(2));

        // Update total allocated
        const totalSpan = document.querySelector(
            `.total-allocated[data-product="${productId}"]`);
        if (totalSpan) totalSpan.textContent = totalAllocated.toFixed(2);

        // Update remaining
        const remainSpan = document.querySelector(
            `.remaining[data-product="${productId}"]`);
        if (remainSpan) {
            remainSpan.textContent = remaining.toFixed(2);
            remainSpan.className   = Math.abs(remaining) < 0.001
                ? "remaining remaining-zero"
                : "remaining remaining-nonzero";
        }

        // Update status badge
        const badge = document.getElementById("status_" + productId);
        if (badge) {
            if (Math.abs(remaining) < 0.001) {
                badge.textContent = "ALLOCATED";
                badge.className   = "badge bg-success";
            } else if (remaining < 0) {
                badge.textContent = "OVER LIMIT";
                badge.className   = "badge bg-warning text-dark";
            } else {
                badge.textContent = "PENDING";
                badge.className   = "badge bg-danger";
            }
        }

        recalculateTotals();
    }

    // ── Recalculate footer totals ────────────────────────────────────────
    function recalculateTotals() {
        let totalStockroom = 0;
        let totalAllocated = 0;
        let totalRemaining = 0;
        const wellTotals   = {};
        wellNames.forEach(w => wellTotals[w] = 0);

        document.querySelectorAll("tbody tr[data-product]").forEach(row => {
            const productId = row.dataset.product;
            const stockroom = parseFloat(row.dataset.stockroom) || 0;
            totalStockroom += stockroom;

            let rowAllocated = 0;
            wellNames.forEach(wellName => {
                const input = row.querySelector(
                    `input[name="alloc_${productId}_${wellName}"]`);
                const val = parseFloat(input?.value) || 0;
                rowAllocated         += val;
                wellTotals[wellName] += val;
            });

            totalAllocated += rowAllocated;
            totalRemaining += (stockroom - rowAllocated);
        });

        document.getElementById("totalStockroom").textContent =
            totalStockroom.toFixed(2);
        document.getElementById("totalAllocated").textContent =
            totalAllocated.toFixed(2);
        document.getElementById("totalRemaining").textContent =
            totalRemaining.toFixed(2);

        wellNames.forEach(wellName => {
            const el = document.getElementById("totalWell_" + wellName);
            if (el) el.textContent = wellTotals[wellName].toFixed(2);
        });
    }

    // ── Auto distribute equally across wells ─────────────────────────────
    function autoDistribute() {
        document.querySelectorAll("tbody tr[data-product]").forEach(row => {
            const productId = row.dataset.product;
            const stockroom = parseFloat(row.dataset.stockroom) || 0;
            const perWell   = stockroom / wellNames.length;

            wellNames.forEach((wellName, index) => {
                const input = row.querySelector(
                    `input[name="alloc_${productId}_${wellName}"]`);
                if (!input) return;

                if (index === wellNames.length - 1) {
                    // Last well gets remainder to avoid rounding loss
                    let sumSoFar = 0;
                    for (let i = 0; i < wellNames.length - 1; i++) {
                        const prev = row.querySelector(
                            `input[name="alloc_${productId}_${wellNames[i]}"]`);
                        sumSoFar += parseFloat(prev?.value) || 0;
                    }
                    input.value = (stockroom - sumSoFar).toFixed(2);
                } else {
                    input.value = perWell.toFixed(2);
                }
            });

            recalculateRow(productId);
        });
    }

    // ── Validate all rows then submit ────────────────────────────────────
    function validateAndSave() {
        const errorDiv = document.getElementById("globalError");
        const errorMsg = document.getElementById("globalErrorMsg");
        errorDiv.style.display = "none";

        const errors = [];

        document.querySelectorAll("tbody tr[data-product]").forEach(row => {
            const productId   = row.dataset.product;
            const stockroom   = parseFloat(row.dataset.stockroom) || 0;
            const productName = row.querySelector("strong")?.textContent?.trim()
                                || productId;

            let totalAllocated = 0;
            let hasNegative    = false;

            wellNames.forEach(wellName => {
                const input = row.querySelector(
                    `input[name="alloc_${productId}_${wellName}"]`);
                const val = parseFloat(input?.value) || 0;
                if (val < 0) hasNegative = true;
                totalAllocated += val;
            });

            if (hasNegative) {
                errors.push(`"${productName}": negative values not allowed.`);
            }

            const remaining = stockroom - totalAllocated;

            if (Math.abs(remaining) > 0.001) {
                errors.push(`"${productName}": ${remaining.toFixed(2)} units remaining.`);
            }
        });

        if (errors.length > 0) {
            errorMsg.innerHTML = "<strong>Fix before proceeding:</strong><br>"
                + errors.join("<br>");
            errorDiv.style.display = "block";
            window.scrollTo({ top: 0, behavior: "smooth" });
            return;
        }

        // ✅ All products fully allocated — submit
        document.getElementById("distributionForm").submit();
    }

    // ── Attach listeners ─────────────────────────────────────────────────
    document.querySelectorAll(".well-allocation").forEach(input => {
        input.addEventListener("input", () => recalculateRow(input.dataset.product));
    });

    // ── Initial calculation on load ──────────────────────────────────────
    document.querySelectorAll("tbody tr[data-product]").forEach(row => {
        recalculateRow(row.dataset.product);
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>